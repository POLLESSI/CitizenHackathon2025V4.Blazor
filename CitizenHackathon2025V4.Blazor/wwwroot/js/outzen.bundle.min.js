import *as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js'; import L from 'https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js'; import 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js'; import *as signalR from 'https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js'; class LeafletMap { constructor(t, e = [50.89, 4.34], i = 13) { this.map = L.map(t).setView(e, i), L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(this.map), this.markers = L.markerClusterGroup(), this.map.addLayer(this.markers) } addMarker(t, e, i, s, n) { const a = L.marker([e, i], { title: t }).bindPopup(s); a.level = n, this.markers.addLayer(a) } removeMarker(t) { this.markers.eachLayer(e => { e.options.title === t && this.markers.removeLayer(e) }) } } class SignalRClient { constructor(t) { this.connection = new signalR.HubConnectionBuilder().withUrl(t).build() } start() { return this.connection.start().catch(t => console.error(t)) } on(t, e) { this.connection.on(t, e) } } export default function OutZenApp({ mapId: t, center: e, zoom: i, enableChart: s }) { const a = new LeafletMap(t, e, i), o = new SignalRClient('/outzenHub'); return o.start().then(() => console.log('✅ SignalR connected')), o.on('UpdateCrowd', e => { a.addMarker(e.id, e.lat, e.lng, e.info, e.level) }), s && (() => { const t = document.createElement('canvas'); document.body.appendChild(t), new Chart(t, { type: 'bar', data: { labels: [], datasets: [{ label: 'Affluence', data: [] }] } }) })(), { addOrUpdateCrowdMarker: (t, e, i, s, n) => a.addMarker(t, e, i, n, s), removeCrowdMarker: t => a.removeMarker(t), setFilterLevel: t => { a.markers.eachLayer(e => { e.level !== t ? e.setOpacity(.3) : e.setOpacity(1) }) } } } function animateBackground() { const t = document.getElementById('geometryCanvas'); if (!t) return; const e = t.getContext('2d'); let i = 0; !function n() { e.fillStyle = `hsl(${i % 360},50%,5%)`, e.fillRect(0, 0, t.width, t.height), i += .5, requestAnimationFrame(n) }() } animateBackground();
